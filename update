# Deploys and tests the flask app on webservers
- hosts: devA,devB,devC
  become: yes
  tasks:
    
    - name: install python3
      apt:
        name: python3   
        state: latest
        
    - name: install python3-pip
      apt:
         name: python3-pip
         state: latest   
    - name: create a new directory
      file:
        path: /home/ubuntu/flask-app 
        state: directory
        owner: ubuntu
        group: ubuntu
        
    - name: change directory to flask-app
      shell: cd /home/ubuntu/flask-app
    
    - name: Install Flask in virtual environment
      pip:
        name: flask
        state: present
    - name: Install python3-venv package
      become: true
      apt:
        name: python3-venv
        state: present
    - name: create virtual environment
      shell: python3.8 -m venv /home/ubuntu/flask-app/venv
        
    - name: create virtual environment directory
      file:
        path: /home/ubuntu/flask-app/venv
        state: directory
        owner: ubuntu
        group: ubuntu
      
    - name: activate virtual environment
      become: yes
      become_user: ubuntu
      shell: . /home/ubuntu/flask-app/venv/bin/activate
      args:
        chdir: /home/ubuntu/flask-app
    
    - name: copy the flask app code to the servers
      copy:
        src:  app.py
        dest: /home/ubuntu/flask-app/venv/app.py
        mode: 0775
    
    - name: execute the flask-app deployment
      shell: flask run -h 0.0.0.0 -p 5000
      async: 500
      poll: 0
